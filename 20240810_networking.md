##### 《计算机网络 自顶层向下方法》笔记
###### 第2章 应用层
应用程序：运行在不同端系统，通过网络彼此通信的程序。应用程序只能运行在端系统，不能运行在网络核心设备如路由器、链路交换机，网络核心设备不在应用层上起作用，仅在网络层及以下起作用。应用程序体系结构，主流两种，客户-服务器体系结构、对等P2P体系结构。    

客户-服务器体系结构：服务器总是打开的；服务器服务客户的请求；客户之间不直接通信；服务器具有固定的IP地址。Web、FTP、Telnet、电子邮件。  

数据中心：大量主机结合创建强大的虚拟服务器。一台单独的服务器常常跟不上其大量的客户请求。一个数据中心可以有数十万台服务器，它们必须供电和维护，服务提供商必须不断支付互联和带宽费用以收发来自数据中心的数据。搜索引擎、基于Web电子邮件、社交网络。  

对等P2P体系结构：P2P对于数据中心的专用服务器没有或有最小依赖，应用程序在间断连接的主机对即对等方之间直接通信，对等方不必通过专门的服务器。文件共享、对等方协助下载加速器、电话视频会议。混合体系结构，许多应用结合客户-服务器和P2P，服务器用于跟踪用户IP，用户到用户的报文无需通过中间服务器直接发送。  

P2P的自扩展性：每个鬼灯放由于请求文件产生工作负载，而每个对等方通过向彼此分发文件也为系统增加服务能力。  

进程通信：多个端系统互相通信，实际上是端系统上程序的进程相互通信。同一端系统上不同程序的通信，使用操作系统规定的进程间通信机制。主要讨论不同端系统的进程通信。发送端进程生成并发送报文，接收端进程接收报文并回送响应报文。  

客户-服务器进程：网络应用程序由成对的进程组成，进程通过网络相互发送报文。每对通信进程，发起通信的进程是客户，等待联系的进程是服务器。在某些应用程序如P2P文件共享中，一个进程既可能是客户又可能是服务器。  

套接字：套接字是应用层程序进程与运输层协议之间的接口，是应用程序和网络之间的应用程序编程接口API。发送端应用程序将报文推进套接字，接收端运输层协议将报文从套接字取出。开发者可以控制套接字在应用层端的一切，但对运输层端少有控制权。对运输层的控制权仅限于，选择运输层协议，设定几个运输层参数如最大缓存、最大报文段长度。  

进程寻址：主机向另一台主机的进程发送分组，为准确送达，需要目标识目的主机和接收进程。主机由IP地址标识，IP地址由32位比特构成。接收进程由接收套接字标识，应用程序由端口号标识因特网标准协议定义了流行应用周知端口号，如Web端口号80，邮件端口号25。  

运输层协议：包括因特网在内的很多网络提供了很多运输层协议，每种运输层协议提供了不同的服务，在开发应用的时候，必须选择其中一种。计算机网络提供的运输层协议服务可划分为四类：可靠数据传输、吞吐量、定时、安全性。  

可靠数据传输：分组在网络中传输可能丢失，如分组在路由器中缓存溢出，或分组中比特损坏被丢弃。运输层协议提供进程到进程的可靠数据传输服务时，发送端只需将数据传进套接字，就能实现数据正确、完整的传输。容忍丢失的应用如多媒体应用，交谈式音视频能够接受一定量的数据丢失，运输层协议可以不提供可靠数据传输。  

吞吐量：运输层协议能够提供恒定速率吞吐量。当两进程通信时，发送进程能够向接收进程交付比特的速率就是可用吞吐量，由于其他会话共享网络路径带宽，这些会话的到来和离开会使可用吞吐量随时间波动。运输层协议提供恒定速率至少r比特/秒的确保吞吐量，如因特网电话应用程序对语音以32kbps的速率进行编码，若运输层协议不能提供这种吞吐量，该应用程序或以较低速率进行编码，或放弃发送。具有吞吐量要求的应用程序称为带宽敏感的应用，如多媒体应用，这些应用也许采用自适应编码技术，对数字音视频以与当前可用带宽相匹配的速率进行编码。弹性应用，能够根据可用带宽利用可供使用的吞吐量，如电子邮件、文件传输、Web传送。通常，吞吐量越多越好。  

定时：运输层协议提供定时保证，如发送方注入套接字的每个比特到达接收方套接字的时间不少于100ms。常用于实时交互应用程序，如因特网电话会议、虚拟环境、联机游戏，对时延有较严格的限制。非实时应用程序对端到端时延约束较为宽松，通常时延越低越好。  

安全性：运输层协议能够为应用程序提供一或多中安全性服务，如发送方加密传输数据，接收方解密数据后交付给进程。除此之外，运输层协议还可提供数据完整性和端点鉴别服务。  

因特网的运输层协议服务：因特网，更一般的是TCP/IP网络，为应用层提供两种运输层协议，UDP和TCP，应用程序开发者需要选择其中之一，每个协议为应用程序提供了不同服务的集合。  

TCP服务：TCP服务模型包括面向连接服务和可靠数据传输服务，还具有拥塞控制机制。应用程序调用TCP作为运输协议时，就能获得TCP的这两种服务。电子邮件、远程终端访问、Web、文件传输。  

TCP面向连接的服务：在应用层数据开始传送之前，TCP让客户和服务器相互交换运输层控制信息，这个握手过程提醒客户和服务器，为大量分组的到来做好准备，握手阶段在两个套接字间建立了一个TCP连接。连接是全双工的，即双方进程可以在连接上同时收发报文，当报文传输结束，要拆除连接。  

TCP可靠数据传输服务：进程能够依靠TCP，无差错、按顺序收发全部数据。  

TCP拥塞控制机制：该服务不一定为通信进程带来直接好处，但能为因特网整体带来好处，当发送方和接收方间的网络出现拥塞时，TCP拥塞控制会抑制发送进程客户或服务器，或限制TCP连接，为使其公平共享网络带宽。  

SSL：运输层协议TCP或UDP本身没有加密机制，发送进程发送什么样的数据，接收方进程就收到什么样的数据。使用安全套接字层SSL加强的TCP能够提供进程到进程的安全性服务，包括加密、数据完整性检测、端点鉴别。SSL不是与TCP、UDP同级的第三种因特网运输协议，而是在应用层上实现的对TCP的强化。如果一个应用程序要使用SSL服务，它的客户端和服务器端需包括SSL代码，SSL有自己的套接字API。发送进程向SSL套接字传送明文数据，发送端SSL加密该数据并传递给TCP套接字，加密数据经因特网传输给接收端TCP套接字，再传给接收端SSL进行解密。  

UDP服务：UDP仅提供最小服务，即不提供不必要服务。UDP是无连接的，两个进程通信之前没有握手过程。UDP提供不可靠数据传输，当进程传送报文时，接收端不一定收到或可能以乱序收到发送的报文。UDP没有拥塞控制机制，发送端可以选用任何速率向网络层注入数据，由于中间链路带宽受限或拥塞，实际端到端吞吐量可能更小。因特网电话应用使用UDP，容忍一定丢失以达到一定速率，避开TCP的拥塞控制和分组开销。但由于大多防火墙被设置成阻挡多数类型的UDP流量，因此因特网电话应用常被设计成若UDP通信失败就使用TCP作为备份。  

网络运输协议与因特网运输协议：网络的运输协议服务包括四类，可靠数据传输、吞吐量、定时、安全性。TCP提供可靠的端到端数据传送，SSL加强以保证安全性。从TCP和UDP看，因特网运输层不提供吞吐量和定时保证服务。对于在因特网上运行的时间敏感应用，它们被设计成尽最大可能对付减少时延。因特网可以为时间敏感应用如因特网电话提供较好的服务，但它不提供任何定时或带宽保证。  

```
因特网应用、应用层协议、运输协议  
电子邮件：SMTP、TCP；  
远程终端访问：Telnet、TCP；  
Web：HTTP、TCP；  
文件传输：FTP、TCP；  
流式多媒体：HTTP、TCP；  
因特网电话：SIP/RTP/或专用、UDP/TCP  
```

应用层协议：报文放进套接字实现进程通信，应用层协议定义了在不同端系统上的应用进程如何互传报文，包括报文类型如请求或相应、报文语法、字段语义、何时如何发送报文、响应报文。有些应用层协议由RFC文档定义，因此它们位于公共域中，如HTTP可以作为一个RFC使用，开发者遵循HTTP RFC规则开发出的浏览器能访问遵循该标准的服务器并获得Web页面；有些应用层协议是专用的，不为公共域使用。 应用层协议是网络应用的一部分，如Web是一种客户-服务器应用，Web由文档格式标准即HTML、浏览器、服务器、应用层协议HTTP组成；电子邮件是应用程序，由邮件服务器、邮件客户程序、定义邮件报文结构的标准、报文如何传递的应用层协议、解释报文首部信息的应用层协议SMTP组成。  

主要因特网应用：Web、文件传输、带脑子有几案、目录服务DNS、流式视频、P2P；  

Web和HTTP：20世纪90年代以前，因特网在学术研究界外鲜为人知，直到万维网出台，使因特网从众多数据网中脱颖而出。Web的应用层协议即超文本传输协议HTTP，是Web的核心。HTTP定义了客户与服务器程序交换报文的结构和方式。  

Web页面：由对象组成，多数Web页面含有一个HTML基本文件和几个引用对象。对象是一个文件，可以是HTML文件、JPEG图片、Java小程序、视频文件，它们通过URL地址寻址，URL由存放对象的服务器主机名和对象的路径名组成。URL如http://www.someSchool.edu/someDepartment/picture.gif，www.someSchool.edu为主机名，剩下为路径名。Web浏览器即Web客户实现了HTTP的客户端，Web服务器实现了HTTP的服务器端。  

HTTP使用TCP作为运输协议，TCP为HTTP提供可靠数据传输服务。HTTP客户首先向服务器发起连接，连接建立好，浏览器和服务器进程就可以通过套接字接口访问TCP，客户向套接字发送HTTP请求报文并接收HTTP响应报文，服务器向套接字接收HTTP请求报文并发送HTTP响应报文。当客户向套接字发送了请求报文，该报文就脱离了客户控制进入TCP控制，体现了分层体系结构的特点，HTTP不用关注TCP恢复数据丢失和乱序的细节。  

HTTP是一种无状态协议，服务器不会区别在短时间内来自同一个客户的重复请求，而是把每次请求当作全新的请求，每次都会重新发送被请求的对象。  

HTTP的TCP连接：非持续连接，每个请求经单独的TCP连接发送，持续连接，所有请求经相同的TCP发送。面对客户的一系列请求，HTTP默认使用持续连接，也能使用非持续连接。  

HTTP采用非持续TCP连接：
服务器向客户传送一个Web页面，该页面包括一个HTML基本页面和10个JPEG图片共11个对象，存储在同一服务器上。HTML文件的URL为http://www.someSchool.edu/someDepartment/home.index  
（1）客户进程在默认端口号80向服务器www.someSchool.edu发起TCP连接。  
（2）客户向服务器发送HTTP请求报文，报文包含了路径名/someDepartment/home.index。  
（3）服务器经套接字接收到请求报文，从其存储器RAM或磁盘中检索出对象www.someSchool.edu/someDepartment/home.index，将其封装到响应报文中，通过套接字发送给客户。  
（4）服务器通知TCP断开该TCP连接，确认客户完整收到响应报文，TCP连接关闭。  
（5）客户从响应报文中提取出HTML文件，得到对10个图片的引用，对每个引用的图片重复前面步骤。  
本次客户请求服务器的Web页面，要产生11个TCP连接，每个TCP连接至传输一个请求报文和一个响应报文，完毕后该连接关闭。对于10个JPEG图片的TCP连接，用户可以配置浏览器以控制连接的并行度，浏览器默认开启5~10个并行TCP连接，若将最大并行连接数设置为1，就会串行连接，并行连接可以缩短响应时间。  
往返时间RTT：一个分组从客户到服务器再返回客户的时间。RTT包括传播时延、排队时延、处理时延。用户点击超链接，浏览器和Web服务器建立TCP连接，涉及三次握手。客户向服务器发送一小段TCP报文，服务器向客户发送一小段TCP响应报文，客户向服务器发起确认以及正式请求，三次握手后，服务器向客户发送请求的HTML对象。三次握手的前两次占用一个RTT，正式请求和回传文件占用另一个RTT，因此，总响应时间可视为两个RTT加上传输HTML文件的时间。  
非持续连接的缺点：为每一个请求对象建立全新的连接，客户和服务器都要分配TCP的缓冲区并保持TCP变量，对同时服务于数以百计不同客户请求的服务器来说负荷太重。每个对象都要经受两倍RTT交付时延，一个用于创建TCP连接，一个用于请求和接收对象。  

HTTP采用持续TCP连接：服务器在发送响应报文后保持TCP连接，在相同的客户与服务器间的持续请求与响应可共用一个TCP连接，一个完整的Web页面甚至一个服务器上多个Web页面可以仅有一个TCP连接，通常，一条经一定时间未被使用的连接会自动关闭。HTTP/2是HTTP 1.1改版，允许在相同连接中交错多个请求与响应。  


